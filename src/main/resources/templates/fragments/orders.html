<!DOCTYPE html>
<html layout:decorate="~{layout}">

<head>
    <title>Orders</title>
</head>

<body>
    <div layout:fragment="content">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Orders</h4>
            <a sec:authorize="hasRole('ADMIN')" th:href="@{/order}" class="btn btn-dark">
                <i class="fas fa-plus"></i> Add a new order
            </a>
        </div>

        <!-- Search/filter input -->
        <div class="mb-3">
            <input id="searchInput" type="text" class="form-control" placeholder="Search orders...">
        </div>

        <table class="table table-bordered table-hover" id="ordersTable">
            <thead class="table-dark">
                <tr>
                    <th class="text-center">Invoice No.</th>
                    <th class="text-center">Customer Name</th>
                    <th class="text-center">Date</th>
                    <th class="text-center">Total Amount</th>
                    <th class="text-center">Amount Paid</th>
                    <th class="text-center">Amount Due</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="order : ${order_page.content}">
                    <td th:text="${order.invoiceNumber}"></td>
                    <td th:text="${order.customer?.name}"></td>
                    <td th:text="${#temporals.format(order.dateOrdered, 'yyyy-MM-dd')}"></td>
                    <td th:text="${order.totalAmount}"></td>
                    <td th:text="${order.amountPaid}"></td>
                    <td th:text="${order.amountDue}"></td>
                    <td class="d-flex gap-1">
						    <a th:href="@{/order/{id}(id=${order.id})}" class="btn btn-primary btn-sm">
						        <i class="fas fa-edit"></i>
						    </a>
						
						    <button type="button" 
						            th:attr="data-id=${order.id}" 
						            class="btn btn-danger btn-sm" 
						            data-bs-toggle="modal" 
						            data-bs-target="#deleteConfirmationModal">
						        <i class="fas fa-trash"></i>
						    </button>
						
						    <button type="button" 
						            th:attr="data-id=${order.id}" 
						            class="btn btn-info btn-sm view-order-details" 
						            data-bs-toggle="modal" 
						            data-bs-target="#viewOrderModal">
						        <i class="fas fa-eye"></i>
						    </button>
						
						   <!-- Receive Payment button, only if amountDue != 0 -->
							<button type="button"
							        th:if="${order.amountDue != 0}"
							        th:attr="data-id=${order.id}, data-invoice=${order.invoiceNumber}, data-grandtotal=${order.totalAmount}, data-amountdue=${order.amountDue}"
							        class="btn btn-success btn-sm receive-payment-btn"
							        data-bs-toggle="modal"
							        data-bs-target="#paymentModal">
							    <i class="fas fa-money-bill-wave"></i>
							</button>

						</td>

                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <nav th:if="${order_page.totalPages > 1}" class="d-flex justify-content-center">
            <ul class="pagination">
                <li class="page-item"
                    th:each="i: ${#numbers.sequence(1, order_page.totalPages)}"
                    th:classappend="${i - 1 == order_page.number} ? active">
                    <a class="page-link" th:href="@{/orders(size=${order_page.size}, page=${i})}" th:text="${i}"></a>
                </li>
            </ul>
        </nav>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <form th:action="@{/orders/delete}" method="post">
                    <input type="hidden" name="id" value="">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Order</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">Are you sure you want to delete this order?</div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

      <!-- View Order Details Modal -->
<!-- View Order Invoice Modal -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">
        <!-- Header with logo -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <!-- <img src="https://logodix.com/logo/2111800.jpg" alt="Logo" style="height:80px;"> -->
            <p class="mb-0 fw-bold">Mubin Enterprise</p>
            <p class="mb-0">598,Kunia Targas</p>
            <p class="mb-0">Block-B,Word-37</p>
            <p class="mb-0">Tongi,Gazipur</p>
            <p class="mb-0">Phone: +01819817473</p>
          </div>
          <div class="text-end">
            <h6 class="text-muted">Invoice #</h6>
            <p id="modalInvoiceNumber" class="fw-bold mb-1"></p>

            <h6 class="text-muted">Date</h6>
            <p id="modalOrderDate" class="mb-0"></p>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="mb-4">
          <h6 class="text-muted">Bill To:</h6>
          <p id="modalCustomerName" class="mb-1 fw-bold"></p>
          <p id="modalCustomerPhone" class="mb-1"></p>
          <p id="modalCustomerAddress" class="mb-0"></p>
        </div>

        <!-- Products Table -->
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-light text-center">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="orderDetailsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Grand Total</th>
              <th id="modalTotalAmount" class="text-center"></th>
            </tr>
          </tfoot>
        </table>

        <!-- ðŸ’µ Payment Summary Section -->
        <div class="mt-4 border-top pt-3">
          <div class="row mb-2">
            <div class="col text-end fw-bold">Amount Paid:</div>
            <div class="col-auto text-end" id="modalAmountPaid">0.00</div>
          </div>
          <div class="row mb-2">
            <div class="col text-end fw-bold">Amount Due:</div>
            <div class="col-auto text-end text-danger" id="modalAmountDue">0.00</div>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 text-muted text-center small">
          Thank you for your purchase! Contact mahfuj2050@gmail.com for questions.
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ðŸ’³ Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="receivePaymentForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Receive Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentOrderId">
          <input type="hidden" id="paymentInvoiceNumber">

          <div class="mb-3">
            <label class="form-label">Grand Total</label>
            <input type="text" id="modalGrandTotal" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Current Due</label>
            <input type="text" id="currentAmountDue" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Amount Paid</label>
            <input type="number" id="amountPaidInput" class="form-control" min="0" step="0.01" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Remaining Due</label>
            <input type="text" id="remainingDue" class="form-control" readonly>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Confirm Payment</button>
        </div>
      </div>
    </form>
  </div>
</div>



<script>
$(document).on("click", ".view-order-details", function () {
    const orderId = $(this).data('id');
    $('#orderDetailsBody').empty();
    $('#modalTotalAmount').text('');
    $('#modalCustomerName').text('');
    $('#modalCustomerPhone').text('');
    $('#modalCustomerAddress').text('');
    $('#modalOrderId').text(orderId);
    $('#modalOrderDate').text('');

    $.ajax({
        url: '/order/details/' + orderId,
        method: 'GET',
        success: function (data) {
            let total = 0;
            $("#modalInvoiceNumber").text(data.invoiceNumber);
            $('#modalCustomerName').text(data.customerName);
            $('#modalCustomerPhone').text(data.customerPhone);
            $('#modalCustomerAddress').text(data.customerAddress);
            $('#modalOrderDate').text(data.orderDate);

            data.items.forEach(function (item) {
                const itemTotal = item.quantity * item.price;
                total += itemTotal;

                $('#orderDetailsBody').append(`
                    <tr class="text-center">
                        <td class="text-start">${item.productName}</td>
                        <td>${item.quantity}</td>
                        <td>${parseFloat(item.price).toFixed(2)}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                    </tr>
                `);
            });



            $('#modalTotalAmount').text(total.toFixed(2));

            // âœ… FIX HERE â€” use data.amountPaid and data.amountDue
            $("#modalAmountPaid").text(parseFloat(data.amountPaid).toFixed(2));
            $("#modalAmountDue").text(parseFloat(data.amountDue).toFixed(2));

            $('#viewOrderModal').modal('show');
        }
    });
});


$(document).on("click", ".receive-payment-btn", function () {
    const orderId = $(this).data("id");
    const invoice = $(this).data("invoice");
    const grandTotal = parseFloat($(this).data("grandtotal"));
    const amountDue = parseFloat($(this).data("amountdue"));

    $("#paymentOrderId").val(orderId);
    $("#paymentInvoiceNumber").val(invoice);
    $("#modalGrandTotal").val(grandTotal.toFixed(2));
    $("#currentAmountDue").val(amountDue.toFixed(2));
    $("#amountPaidInput").val("");
    $("#remainingDue").val(amountDue.toFixed(2));
});

// ðŸ§® Calculate remaining due
$(document).on("input", "#amountPaidInput", function () {
    const paid = parseFloat($(this).val()) || 0;
    const currentDue = parseFloat($("#currentAmountDue").val());
    const remaining = Math.max(currentDue - paid, 0);
    $("#remainingDue").val(remaining.toFixed(2));
});


$(document).on("submit", "#receivePaymentForm", function (e) {
    e.preventDefault();

    const orderId = $("#paymentOrderId").val();
    const amountPaid = parseFloat($("#amountPaidInput").val());

    $.post("/pos/receivePayment", { orderId, amountPaid })
        .done(function (res) {
            // Update table row if needed
            const row = $(`button[data-id='${orderId}']`).closest("tr");
            row.find(".amount-paid").text(res.amountPaid.toFixed(2));
            row.find(".amount-due").text(res.amountDue.toFixed(2));

            // Close modal
            const modalEl = document.getElementById("paymentModal");
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();
            
            // âœ… Refresh the page
            location.reload();
        })
        .fail(function () {
            alert("Error updating payment");
        });
});

</script>


    </div>
</body>
</html>
