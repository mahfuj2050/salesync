<!DOCTYPE html>
<html layout:decorate="~{layout}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<head>
    <title>Sales List</title>
    
  <style>
    .summary-card {
      transition: transform 0.2s;
    }
    .summary-card:hover {
      transform: translateY(-2px);
    }
    .bg-light-blue {
      background-color: #e3f2fd;
    }
    .bg-light-orange {
      background-color: #fff3e0;
    }
    .bg-light-green {
      background-color: #e8f5e9;
    }
    .bg-light-purple {
      background-color: #f3e5f5;
    }
    .status-badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 12px;
    }
    .pagination .page-link {
      color: #495057;
    }
    .pagination .page-item.active .page-link {
      background-color: #007bff;
      border-color: #007bff;
    }
    .action-buttons .btn {
      margin: 2px;
    }
  </style>
</head>

<body>
  <div layout:fragment="content" class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3"><i class="bi bi-receipt-cutoff"></i> Sale Order Management</h1>
      <a sec:authorize="hasRole('ADMIN')" th:href="@{/pos}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Create New Order
      </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card summary-card border-primary bg-light-blue">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-primary mb-1">Total Orders</h6>
                <h3 class="text-primary mb-0" th:text="${totalOrders}">0</h3>
                <small class="text-muted">All time orders</small>
              </div>
              <i class="bi bi-receipt text-primary" style="font-size: 2.5rem; opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card border-success bg-light-green">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-success mb-1">Total Revenue</h6>
                <h3 class="text-success mb-0" th:text="${#numbers.formatDecimal(totalRevenue, 1, 2, 'POINT')}">0.00</h3>
                <small class="text-muted">Total sales amount</small>
              </div>
              <i class="bi bi-currency-dollar text-success" style="font-size: 2.5rem; opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card border-warning bg-light-orange">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-warning mb-1">Pending Payments</h6>
                <h3 class="text-warning mb-0" th:text="${#numbers.formatDecimal(totalDue, 1, 2, 'POINT')}">0.00</h3>
                <small class="text-muted">Outstanding amount</small>
              </div>
              <i class="bi bi-hourglass-split text-warning" style="font-size: 2.5rem; opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-3">
        <div class="card summary-card border-info bg-light-purple">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-info mb-1">Today's Orders</h6>
                <h3 class="text-info mb-0" th:text="${todayOrders}">0</h3>
                <small class="text-muted">Orders placed today</small>
              </div>
              <i class="bi bi-calendar-check text-info" style="font-size: 2.5rem; opacity: 0.7;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form th:action="@{/orders}" method="get" class="row g-3" id="filterForm">
          <input type="hidden" name="page" th:value="${currentPage}">
          <input type="hidden" name="size" th:value="${currentSize}">
          
          <div class="col-md-3">
            <label class="form-label small text-muted">Search</label>
            <input type="text" class="form-control" name="search" 
                   th:value="${currentSearch}" 
                   placeholder="Invoice #, Customer name...">
          </div>
          
          <div class="col-md-2">
            <label class="form-label small text-muted">Payment Status</label>
            <select class="form-select" name="paymentStatus">
              <option value="">All Payments</option>
              <option value="paid" th:selected="${currentPaymentStatus == 'paid'}">Fully Paid</option>
              <option value="partial" th:selected="${currentPaymentStatus == 'partial'}">Partial Payment</option>
              <option value="unpaid" th:selected="${currentPaymentStatus == 'unpaid'}">Unpaid</option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label class="form-label small text-muted">Date Range</label>
            <select class="form-select" name="dateRange">
              <option value="">All Time</option>
              <option value="today" th:selected="${currentDateRange == 'today'}">Today</option>
              <option value="week" th:selected="${currentDateRange == 'week'}">This Week</option>
              <option value="month" th:selected="${currentDateRange == 'month'}">This Month</option>
              <option value="year" th:selected="${currentDateRange == 'year'}">This Year</option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label class="form-label small text-muted">From Date</label>
            <input type="date" class="form-control" name="fromDate" th:value="${fromDate}">
          </div>
          
          <div class="col-md-2">
            <label class="form-label small text-muted">To Date</label>
            <input type="date" class="form-control" name="toDate" th:value="${toDate}">
          </div>
          
          <div class="col-md-1 d-flex align-items-end">
            <div class="btn-group w-100">
              <button type="submit" class="btn btn-outline-primary" title="Apply Filters">Filter
                <i class="bi bi-funnel"></i>
              </button>
              <a th:href="@{/orders}" class="btn btn-outline-secondary" title="Clear Filters">Clear
                <i class="bi bi-arrow-clockwise"></i>
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Alerts -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle"></i> <span th:text="${successMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle"></i> <span th:text="${errorMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Orders Table -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">

        <table class="table table-bordered table-hover" id="ordersTable">
            <thead class="table-dark">
                <tr>
                    <th class="text-center">Invoice No.</th>
                    <th class="text-center">Customer Name</th>
                    <th class="text-center">Date</th>
                    <th class="text-center">Total Amount</th>
                    <th class="text-center">Amount Paid</th>
                    <th class="text-center">Amount Due</th>
                    <th class="text-center">Payment Status</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="order : ${order_page.content}">
                    <td th:text="${order.invoiceNumber}"></td>
                    <td th:text="${order.customer?.name}"></td>
                    <td th:text="${#temporals.format(order.dateOrdered, 'yyyy-MM-dd')}"></td>
                    <td class="text-end">
	                  <strong th:text="${#numbers.formatDecimal(order.totalAmount, 1, 2, 'POINT')}"></strong>
	                </td>
	                <td class="text-end text-success">
	                  <span th:text="${#numbers.formatDecimal(order.amountPaid, 1, 2, 'POINT')}"></span>
	                </td>
	                <td class="text-end" th:classappend="${order.amountDue > 0 ? 'text-danger' : 'text-muted'}">
	                  <span th:text="${#numbers.formatDecimal(order.amountDue, 1, 2, 'POINT')}"></span>
	                </td>
	                <td class="text-center">
	                  <span th:if="${order.amountDue == 0}" class="badge bg-success status-badge">
	                    <i class="bi bi-check-circle"></i> Paid
	                  </span>
	                  <span th:if="${order.amountDue > 0 and order.amountPaid > 0}" class="badge bg-warning status-badge">
	                    <i class="bi bi-clock"></i> Partial
	                  </span>
	                  <span th:if="${order.amountDue > 0 and order.amountPaid == 0}" class="badge bg-danger status-badge">
	                    <i class="bi bi-x-circle"></i> Unpaid
	                  </span>
	                </td>
                    <td class="text-center">
                  		<div class="btn-group btn-group-sm action-buttons">
						    <a th:href="@{/order/{id}(id=${order.id})}" class="btn btn-primary btn-sm">
						        <i class="fas fa-edit"></i>
						    </a>
						
						    <button type="button" 
						            th:attr="data-id=${order.id}" 
						            class="btn btn-danger btn-sm" 
						            data-bs-toggle="modal" 
						            data-bs-target="#deleteConfirmationModal">
						        <i class="fas fa-trash"></i>
						    </button>
						
						    <button type="button" 
						            th:attr="data-id=${order.id}" 
						            class="btn btn-info btn-sm view-order-details" 
						            data-bs-toggle="modal" 
						            data-bs-target="#viewOrderModal">
						        <i class="fas fa-eye"></i>
						    </button>
						
						   <!-- Receive Payment button, only if amountDue != 0 -->
							<button type="button"
							        th:if="${order.amountDue != 0}"
							        th:attr="data-id=${order.id}, data-invoice=${order.invoiceNumber}, data-grandtotal=${order.totalAmount}, data-amountdue=${order.amountDue}"
							        class="btn btn-success btn-sm receive-payment-btn"
							        data-bs-toggle="modal"
							        data-bs-target="#paymentModal">
							    <i class="fas fa-money-bill-wave"></i>
							</button>
							</div>
						</td>
                </tr>
      

              <tr th:if="${#lists.isEmpty(order_page.content)}">
                <td colspan="8" class="text-center text-muted py-5">
                  <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                  <p class="mt-3 mb-2">No orders found</p>
                  <a th:href="@{/orders}" class="btn btn-primary btn-sm">Clear Filters</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav th:if="${order_page.totalPages > 1}">
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted small">
              Showing <span th:text="${order_page.number * order_page.size + 1}">1</span> to 
              <span th:text="${(order_page.number * order_page.size) + order_page.numberOfElements}">0</span> of 
              <span th:text="${order_page.totalElements}">0</span> orders
            </div>
            
            <ul class="pagination justify-content-center mb-0">
              <!-- First Page -->
              <li class="page-item" th:classappend="${order_page.first} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/orders(size=${currentSize}, page=0, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, paymentStatus=${currentPaymentStatus}, dateRange=${currentDateRange}, fromDate=${fromDate}, toDate=${toDate})}">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              
              <!-- Previous Page -->
              <li class="page-item" th:classappend="${order_page.first} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/orders(size=${currentSize}, page=${order_page.number - 1}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, paymentStatus=${currentPaymentStatus}, dateRange=${currentDateRange}, fromDate=${fromDate}, toDate=${toDate})}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              
              <!-- Page Numbers -->
              <li th:each="i: ${#numbers.sequence(0, order_page.totalPages-1)}" 
                  class="page-item" 
                  th:classappend="${i == order_page.number} ? 'active'">
                <a class="page-link" 
                   th:href="@{/orders(size=${currentSize}, page=${i}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, paymentStatus=${currentPaymentStatus}, dateRange=${currentDateRange}, fromDate=${fromDate}, toDate=${toDate})}"
                   th:text="${i + 1}">1</a>
              </li>
              
              <!-- Next Page -->
              <li class="page-item" th:classappend="${order_page.last} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/orders(size=${currentSize}, page=${order_page.number + 1}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, paymentStatus=${currentPaymentStatus}, dateRange=${currentDateRange}, fromDate=${fromDate}, toDate=${toDate})}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              
              <!-- Last Page -->
              <li class="page-item" th:classappend="${order_page.last} ? 'disabled'">
                <a class="page-link" 
                   th:href="@{/orders(size=${currentSize}, page=${order_page.totalPages - 1}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, paymentStatus=${currentPaymentStatus}, dateRange=${currentDateRange}, fromDate=${fromDate}, toDate=${toDate})}">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>
            </ul>
            
            <!-- Page Size Selector -->
            <select class="form-select form-select-sm" style="width: auto;" id="pageSizeSelector">
              <option value="10" th:selected="${order_page.size == 10}">10 per page</option>
              <option value="25" th:selected="${order_page.size == 25}">25 per page</option>
              <option value="50" th:selected="${order_page.size == 50}">50 per page</option>
              <option value="100" th:selected="${order_page.size == 100}">100 per page</option>
            </select>
          </div>
        </nav>
      </div>
    </div>


      <!-- View Order Details Modal -->
<!-- View Order Invoice Modal -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">
        <!-- Header with logo -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <!-- <img src="https://logodix.com/logo/2111800.jpg" alt="Logo" style="height:80px;"> -->
            <p class="mb-0 fw-bold">Mubin Enterprise</p>
            <p class="mb-0">598,Kunia Targas</p>
            <p class="mb-0">Block-B,Word-37</p>
            <p class="mb-0">Tongi,Gazipur</p>
            <p class="mb-0">Phone: +01819817473</p>
          </div>
          <div class="text-end">
            <h6 class="text-muted">Invoice #</h6>
            <p id="modalInvoiceNumber" class="fw-bold mb-1"></p>

            <h6 class="text-muted">Date</h6>
            <p id="modalOrderDate" class="mb-0"></p>
          </div>
        </div>

        <!-- Customer Info -->
        <div class="mb-4">
          <h6 class="text-muted">Bill To:</h6>
          <p id="modalCustomerName" class="mb-1 fw-bold"></p>
          <p id="modalCustomerPhone" class="mb-1"></p>
          <p id="modalCustomerAddress" class="mb-0"></p>
        </div>

        <!-- Products Table -->
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-light text-center">
            <tr>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="orderDetailsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-end">Grand Total</th>
              <th id="modalTotalAmount" class="text-center"></th>
            </tr>
          </tfoot>
        </table>

        <!-- ðŸ’µ Payment Summary Section -->
        <div class="mt-4 border-top pt-3">
          <div class="row mb-2">
            <div class="col text-end fw-bold">Amount Paid:</div>
            <div class="col-auto text-end" id="modalAmountPaid">0.00</div>
          </div>
          <div class="row mb-2">
            <div class="col text-end fw-bold">Amount Due:</div>
            <div class="col-auto text-end text-danger" id="modalAmountDue">0.00</div>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 text-muted text-center small">
          Thank you for your purchase! Contact mahfuj2050@gmail.com for questions.
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ðŸ’³ Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="receivePaymentForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Receive Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="paymentOrderId">
          <input type="text" id="paymentInvoiceNumber">

          <div class="mb-3">
            <label class="form-label">Grand Total</label>
            <input type="text" id="modalGrandTotal" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Current Due</label>
            <input type="text" id="currentAmountDue" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Amount Paid</label>
            <input type="number" id="amountPaidInput" class="form-control" min="0" step="0.01" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Remaining Due</label>
            <input type="text" id="remainingDue" class="form-control" readonly>
          </div>
          
         <div class="mb-3">
		  <label class="form-label">Payment Method</label>
		  <select id="paymentMethodSelect" class="form-select">
		      <option value="">-- Select Method --</option>
		      <option value="CASH">Cash</option>
		      <option value="MFS">MFS</option>
		      <option value="BANK">Bank Transfer</option>
		  </select>
		</div>
		
		<div class="mb-3">
		  <label class="form-label">Account</label>
		  <select id="finAccSelect" class="form-select">
		      <option value="">-- Select Account --</option>
		      <!-- Options will be loaded dynamically -->
		  </select>
		</div>
		
		<!-- Hidden inputs for backend submission -->
		<input type="hidden" name="paymentMethod" id="paymentMethodInput">
		<input type="hidden" name="finAccName" id="finAccNameInput">
          
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Confirm Payment</button>
        </div>
      </div>
    </form>
  </div>
</div>



<script>
$(document).on("click", ".view-order-details", function () {
    const orderId = $(this).data('id');
    $('#orderDetailsBody').empty();
    $('#modalTotalAmount').text('');
    $('#modalCustomerName').text('');
    $('#modalCustomerPhone').text('');
    $('#modalCustomerAddress').text('');
    $('#modalOrderId').text(orderId);
    $('#modalOrderDate').text('');

    $.ajax({
        url: '/order/details/' + orderId,
        method: 'GET',
        success: function (data) {
            let total = 0;
            $("#modalInvoiceNumber").text(data.invoiceNumber);
            $('#modalCustomerName').text(data.customerName);
            $('#modalCustomerPhone').text(data.customerPhone);
            $('#modalCustomerAddress').text(data.customerAddress);
            $('#modalOrderDate').text(data.orderDate);

            data.items.forEach(function (item) {
                const itemTotal = item.quantity * item.price;
                total += itemTotal;

                $('#orderDetailsBody').append(`
                    <tr class="text-center">
                        <td class="text-start">${item.productName}</td>
                        <td>${item.quantity}</td>
                        <td>${parseFloat(item.price).toFixed(2)}</td>
                        <td>${itemTotal.toFixed(2)}</td>
                    </tr>
                `);
            });



            $('#modalTotalAmount').text(total.toFixed(2));

            // âœ… FIX HERE â€” use data.amountPaid and data.amountDue
            $("#modalAmountPaid").text(parseFloat(data.amountPaid).toFixed(2));
            $("#modalAmountDue").text(parseFloat(data.amountDue).toFixed(2));

            $('#viewOrderModal').modal('show');
        }
    });
});


$(document).on("click", ".receive-payment-btn", function () {
    const orderId = $(this).data("id");
    const invoice = $(this).data("invoice");
    const grandTotal = parseFloat($(this).data("grandtotal"));
    const amountDue = parseFloat($(this).data("amountdue"));

    $("#paymentOrderId").val(orderId);
    $("#paymentInvoiceNumber").val(invoice);
    $("#modalGrandTotal").val(grandTotal.toFixed(2));
    $("#currentAmountDue").val(amountDue.toFixed(2));
    $("#amountPaidInput").val("");
    $("#remainingDue").val(amountDue.toFixed(2));
    
    $("#paymentMethodSelect").val("");
    $("#finAccSelect").empty().append('<option value="">-- Select Account --</option>');
});

//------------------------
//Step 6: Payment Method change -> load accounts dynamically
//------------------------
$(document).on("change", "#paymentMethodSelect", function() {
 const type = $(this).val();
 const accountSelect = $("#finAccSelect");

 accountSelect.empty().append('<option value="">-- Select Account --</option>');
 if (!type) return;

 $.ajax({
     url: '/accounts/by-type',
     type: 'GET',
     data: { type: type },
     success: function(accounts) {
         accounts.forEach(acc => {
             accountSelect.append(`<option value="${acc.finAccName}">${acc.finAccName}</option>`);
         });
     },
     error: function() { alert("Failed to fetch accounts for " + type); }
 });
});


// ðŸ§® Calculate remaining due
$(document).on("input", "#amountPaidInput", function () {
    const paid = parseFloat($(this).val()) || 0;
    const currentDue = parseFloat($("#currentAmountDue").val());
    const remaining = Math.max(currentDue - paid, 0);
    $("#remainingDue").val(remaining.toFixed(2));
});


$(document).on("submit", "#receivePaymentForm", function (e) {
    e.preventDefault();

    const orderId = $("#paymentOrderId").val();
    const amountPaid = parseFloat($("#amountPaidInput").val());
    const paymentMethod = $("#paymentMethodSelect").val();
    const finAccName = $("#finAccSelect").val();
    const grandTotal = $("#modalGrandTotal").val();
    const currentDue = $("#currentAmountDue").val();
    const remainingDue = $("#remainingDue").val();

    // ðŸ§¾ Log all form values for debugging
    console.log("ðŸ’° Submitting Payment:");
    console.log({
        orderId,
        amountPaid,
        paymentMethod,
        finAccName,
        grandTotal,
        currentDue,
        remainingDue
    });

    if (!amountPaid || amountPaid <= 0) {
        alert("Please enter a valid amount.");
        return;
    }
    if (!paymentMethod) {
        alert("Please select a payment method.");
        return;
    }
    if (!finAccName) {
        alert("Please select an account.");
        return;
    }

    // ðŸ”¥ Submit to backend
    $.ajax({
        url: "/pos/receivePayment",
        type: "POST",
        data: {
            orderId: orderId,
            amountPaid: amountPaid,
            paymentMethod: paymentMethod,
            finAccName: finAccName
        },
        success: function (res) {
            console.log("âœ… Payment saved successfully:", res);

            // Update the row dynamically if table is visible
            const row = $(`button[data-id='${orderId}']`).closest("tr");
            if (row.length) {
                row.find(".amount-paid").text(res.amountPaid.toFixed(2));
                row.find(".amount-due").text(res.amountDue.toFixed(2));
            }

            // Close modal
            const modalEl = document.getElementById("paymentModal");
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Optionally refresh
            location.reload();
        },
        error: function (xhr) {
            console.error("âŒ Payment update failed:", xhr.responseText);
            alert("Error saving payment. Check console for details.");
        }
    });
});

</script>


    </div>
</body>
</html>
