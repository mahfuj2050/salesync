<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
    <title>Purchase Orders</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
    <style>
        .table thead th {
            background-color: #0d6efd;
            color: #fff;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            text-transform: uppercase;
        }
        .status-PENDING {
            background: #ffc107;
            color: #000;
        }
        .status-RECEIVED {
            background: #28a745;
            color: #fff;
        }
        .status-CANCELLED {
            background: #dc3545;
            color: #fff;
        }
    </style>
</head>

<body>
<div layout:fragment="content" class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">ðŸ“¦ Purchase Orders</h3>
        <a href="/purchase/new" class="btn btn-primary">
            <i class="fas fa-plus"></i> New Purchase
        </a>
    </div>

    <!-- âœ… Flash message -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <!-- âœ… Purchase Orders Table -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead>
				<tr>
				    <th>#</th>
				    <th>PO No.</th>
				    <th>Supplier</th>
				    <th>Order Date</th>
				    <th>Total</th>
				    <th>Discount</th>
				    <th>Grand Total</th>
				    <th>Paid</th>
				    <th>Due</th>
				    <th>Status</th>
				    <th>Payment</th>
				    <th class="text-center">Actions</th>
				</tr>
				</thead>
				<tbody>
				<tr th:each="order, iterStat : ${orders}">
				    <td th:text="${iterStat.count}"></td>
				    <td th:text="${order.purchaseOrderNo}"></td>
				    <td th:text="${order.supplierName}"></td>
				    <td th:text="${#temporals.format(order.insertDate, 'dd-MM-yyyy')}"></td>
				
				    <td th:text="${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}"></td>
				    <td th:text="${#numbers.formatDecimal(order.discount, 1, 'COMMA', 2, 'POINT')}"></td>
				    <td th:text="${#numbers.formatDecimal(order.grandTotal, 1, 'COMMA', 2, 'POINT')}"></td>
				    <td th:text="${#numbers.formatDecimal(order.amountPaid, 1, 'COMMA', 2, 'POINT')}"></td>
				    <td th:text="${#numbers.formatDecimal(order.amountDue, 1, 'COMMA', 2, 'POINT')}"></td>
				
				    <td>
				        <span th:text="${order.status}" th:class="'status-badge status-' + ${order.status}"></span>
				    </td>
				    <td>
				        <span th:classappend="'badge bg-' + 
				            (${order.paymentStatus == 'PAID'} ? 'success' : 
				             (${order.paymentStatus == 'PARTIALLY_PAID'} ? 'warning' : 'danger'))"
				              th:text="${order.paymentStatus}"></span>
				    </td>
				
				    <td class="text-center">
				        <button class="btn btn-sm btn-outline-info view-details-btn"
					        th:data-items="${order.itemsJson}"
					        th:data-id="${order.id}"
					        th:data-order="${order.purchaseOrderNo}"
					        th:data-supplier="${order.supplierName}"
					        th:data-date="${#temporals.format(order.insertDate, 'dd-MM-yyyy HH:mm')}"
					        th:data-status="${order.status}"
					        th:data-paymentstatus="${order.paymentStatus}"
					        th:data-total="${order.totalAmount}"
					        th:data-discount="${order.discount}"
					        th:data-grandtotal="${order.grandTotal}"
					        th:data-amountpaid="${order.amountPaid}"
					        th:data-amountdue="${order.amountDue}"
					        th:data-remarks="${order.remarks}">
					    <i class="fas fa-eye"></i> View
					</button>


				    </td>
				</tr>
				</tbody>

        </table>
    </div>

<!-- âœ… Updated Modal for Purchase Order / Invoice -->
<div class="modal fade" id="purchaseDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-sm">
      
      <!-- Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-receipt me-2"></i>Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-4">

        <!-- Company & Order Info -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <p class="mb-0 fw-bold">Mubin Enterprise</p>
            <p class="mb-0">598, Kunia Targas</p>
            <p class="mb-0">Block-B, Word-37</p>
            <p class="mb-0">Tongi, Gazipur</p>
            <p class="mb-0">Phone: +01819817473</p>
          </div>
          <div class="text-end">
            <h6 class="text-muted">Invoice #</h6>
            <p id="modalOrderNo" class="fw-bold mb-1"></p>

            <h6 class="text-muted">Date</h6>
            <p id="modalDate" class="mb-0"></p>

            <h6 class="text-muted">Supplier</h6>
            <p id="modalSupplier" class="mb-0"></p>
          </div>
        </div>

        <!-- Payment / Status Info -->
        <div class="mb-4 row">
          <div class="col-md-6">
            <p><strong>Status:</strong> <span id="modalStatus"></span></p>
            <p><strong>Payment Status:</strong> <span id="modalPaymentStatus"></span></p>
            <p><strong>Remarks:</strong> <span id="modalRemarks"></span></p>
          </div>
          <div class="col-md-6 text-end">
            <p><strong>Total Amount:</strong> <span id="modalGrandTotal"></span></p>
            <p><strong>Amount Paid:</strong> <span id="modalAmountPaid">0.00</span></p>
            <p><strong>Amount Due:</strong> <span id="modalAmountDue">0.00</span></p>
          </div>
        </div>

        <!-- Items Table -->
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-light text-center">
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Purchase Price</th>
              <th>Selling Price</th>
              <th>Subtotal</th>
              <th>VAT %</th>
              <th>VAT Amt</th>
              <th>Subtotal + VAT</th>
            </tr>
          </thead>
          <tbody id="modalItemsBody">
            <!-- JS inserts rows here -->
          </tbody>
          <tfoot>
            <tr>
              <th colspan="8" class="text-end">Grand Total</th>
              <th id="modalGrandTotalFooter" class="text-center"></th>
            </tr>
          </tfoot>
        </table>

        <!-- Footer / Note -->
        <div class="mt-4 text-muted text-center small">
          Thank you for your purchase! Contact <a href="mailto:mahfuj2050@gmail.com">mahfuj2050@gmail.com</a> for questions.
        </div>

      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>


</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<div layout:fragment="scripts">
<script>
document.addEventListener("DOMContentLoaded", () => {

    function formatNumber(num) {
        return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    document.querySelectorAll(".view-details-btn").forEach(btn => {
        btn.addEventListener("click", () => {

            // âœ… Basic info
            document.getElementById("modalOrderNo").textContent = btn.dataset.order;
            document.getElementById("modalSupplier").textContent = btn.dataset.supplier;
            document.getElementById("modalDate").textContent = btn.dataset.date;
            document.getElementById("modalStatus").textContent = btn.dataset.status;
            document.getElementById("modalRemarks").textContent = btn.dataset.remarks || "-";
            document.getElementById("modalPaymentStatus").textContent = btn.dataset.paymentstatus;

            // âœ… Financial info
            document.getElementById("modalGrandTotal").textContent = formatNumber(btn.dataset.grandtotal);
            document.getElementById("modalGrandTotalFooter").textContent = formatNumber(btn.dataset.grandtotal);
            document.getElementById("modalAmountPaid").textContent = formatNumber(btn.dataset.amountpaid);
            document.getElementById("modalAmountDue").textContent = formatNumber(btn.dataset.amountdue);

            // âœ… Items table
            let items = [];
            try {
                items = JSON.parse(btn.dataset.items.replace(/&quot;/g, '"'));
            } catch (e) {
                console.error("Error parsing items:", e);
            }

            const tbody = document.getElementById("modalItemsBody");
            tbody.innerHTML = "";

            items.forEach((item, index) => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.productName}</td>
                    <td>${item.quantity}</td>
                    <td>${formatNumber(item.purchasePrice)}</td>
                    <td>${formatNumber(item.sellingPrice)}</td>
                    <td>${formatNumber(item.subtotal)}</td>
                    <td>${formatNumber(item.vatPercent)}</td>
                    <td>${formatNumber(item.vatAmount)}</td>
                    <td>${formatNumber(item.subtotalWithVat)}</td>
                `;
                tbody.appendChild(tr);
            });

            // âœ… Show modal
            new bootstrap.Modal(document.getElementById("purchaseDetailsModal")).show();
        });
    });
});
</script>
</div>

</body>
</html>
