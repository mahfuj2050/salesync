<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Sales Invoice - POS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	
    <style>
       :root {
	    --theme-color: #0d6efd;
	    --theme-accent: #198754;
	    --text-dark: #212529;
		}
		
		/* Page background and text */
		body {
		    background: #f4f6f9;
		    color: var(--text-dark);
		    font-family: 'Segoe UI', sans-serif;
		}
		
		/* Sale list button styling */
		.sale-list-btn {
		    background: var(--theme-color);
		    color: #fff;
		    font-size: 1rem;
		    padding: 10px 20px !important;
		    border: none!important;
		    border-radius: 8px;
		    font-weight: 600;
		    transition: all 0.3s ease;
		}
		
		.sale-list-btn:hover {
		    background: #0b5ed7;
		    transform: translateY(-2px);
		}
		
		/* Highlight important texts */
		#displayAmountPaid {
		    color: var(--theme-accent);
		    font-weight: bold;
		}
		
		#displayAmountDue {
		    color: #dc3545;
		    font-weight: bold;
		}
		
		#grandTotal,
		#totalAmount {
		    color: var(--theme-color);
		    font-weight: bold;
		    font-size: 1.1rem;
		}
		
		/* Improve form card */
		.card {
		    border: none;
		    border-radius: 12px;
		    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		}
		
		/* Product cards hover enhancement */
		.product-card {
		    cursor: pointer;
		    border: 1px solid #e0e0e0;
		    padding: 10px;
		    text-align: center;
		    border-radius: 12px;
		    background: #CCCCFF;
		    transition: 0.25s;
		}
		.product-card:hover {
		    background: #f1f7ff;
		    border-color: var(--theme-color);
		    transform: translateY(-4px);
		}
		
		/* Section headers and labels */
		h3, label {
		    color: var(--theme-color);
		    font-weight: 600;
		}

        .invoice-table td, .invoice-table th {
            vertical-align: middle;
        }
        #displayAmountPaid {
		    color: green;
		    font-weight: bold;
		}
		
		#displayAmountDue {
		    color: red;
		    font-weight: bold;
		}
		
		/* --- Custom Button Styling (from user input) --- */
		.sale-list-btn {
		    background: var(--theme-color);
		    color: #fff;
		    font-size: 1rem;
		    padding: 10px 20px !important;
		    border: none !important;
		    border-radius: 8px;
		    font-weight: 600;
		    transition: all 0.3s ease;
		    /* Ensure specific border-radius is applied as requested */
		    border-radius: 0 !important; 
		}
		
		.sale-list-btn:hover {
		    background: #0b5ed7;
		    transform: translateY(-2px);
		}
		
		/* --- POS Header --- */
		.pos-header {
		    background: #2196f3;
		    border-radius: 0px;
		    height: 4rem;
		    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
		}
		
		.pos-header h2 {
		    font-size: 1.5rem;
		    letter-spacing: 0.5px;
		}
		
		.header-buttons .header-btn {
		    background: rgba(255, 255, 255, 0.15);
		    color: #fff;
		    padding: 8px 14px;
		    border: none;
		    border-radius: 0px;
		    font-weight: 600;
		    transition: 0.3s;
		}
		
		.header-buttons .header-btn:hover {
		    background: rgba(255, 255, 255, 0.3);
		}
		
		/* --- Customer Section --- */
		.customer-select {
		    border: 2px solid #2196f3;
		    border-radius: 6px;
		    overflow: hidden;
		}
		
		.customer-select select {
		    border: none;
		    box-shadow: none;
		}
		
		.customer-select button {
		    border-left: 2px solid #2196f3;
		    background: #f8f9fa;
		    color: #2196f3;
		    transition: 0.3s;
		}
		
		.customer-select button:hover {
		    background: #2196f3;
		    color: #fff;
		}
		
		/* --- Invoice Table Header --- */
		.invoice-header th {
		    background: #2196f3 !important;
		    color: #fff !important;
		    font-weight: 600;
		    text-transform: uppercase;
		}
		
		        
    </style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("dateOrdered").value = today;
  });
</script>


</head>
<body>

	<div class="container-fluid py-4">
		
		<!-- ‚úÖ Modern POS Header -->
		<div class="pos-header d-flex align-items-center justify-content-between px-4 py-2 mb-3">
		    <h2 class="m-0 text-white fw-bold">
		        üßæ Sales Invoice
		    </h2>
		
		    <div class="header-buttons d-flex gap-3">
		        <button class="header-btn" onclick="window.location.href='/orders'">üìú Sales List</button>
		        <button class="header-btn" onclick="window.location.href='/pos'">üßæ New Invoice</button>
		        <button class="header-btn"  onclick="window.location.href='/products'">üì¶ Product List</button>
		        <button class="header-btn"  onclick="window.location.href='/'">üìä Dashboard</button>
		        <button class="header-btn">‚öôÔ∏è Admin</button>
		    </div>
		</div>

	    <div class="row">
	        <!-- ‚úÖ Left: Invoice Form -->
	        <div class="col-md-7">
	            <div class="card shadow-sm">
	                <div class="card-body">
	                    <form id="posForm" th:action="@{/pos/checkout}" method="post">
	
		                      <div class="row mb-4">
		                      	<div class="col-md-4">
								    <label class="fw-semibold">üë§ Customer</label>
								    <div class="input-group customer-select">
								        <!-- Visible input for name -->
								        <input class="form-control" list="customersList" id="customerInput" placeholder="Select Customer">
								
								        <!-- Hidden input to submit customer ID -->
								        <input type="hidden" name="customerId" id="customerIdHidden">
								
								        <datalist id="customersList">
								            <option th:each="c : ${customers}" th:value="${c.name}" th:data-id="${c.id}"></option>
								        </datalist>
								
								        <button type="button" class="btn btn-outline-primary" id="addCustomerBtn" title="Add Customer" data-bs-toggle="modal" data-bs-target="#customerModal">
								            <i class="fas fa-user-plus"></i>
								        </button>
								    </div>
								</div>

							    <!-- ‚úÖ New: Order Date Picker -->
							    <div class="col-md-3">
							        <label>Order Date</label>
							       <input type="date" class="form-control" name="dateOrdered"
       									id="dateOrdered" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}" required>
							    </div>
							
							    <div class="col-md-5">
							        <label>Search Product</label>
							        <input type="text" id="searchProduct" class="form-control" placeholder="Enter product name or barcode">
							    </div>
							</div>

	
	                        <table class="table table-bordered invoice-table">
	                            <thead class="invoice-header">
									<tr>
									    <th>Item Name</th>
									    <th>Stock</th>
									    <th>Quantity</th>
									    <th>Price</th>
									    <th>Total</th>
									    <th></th>
									</tr>
								</thead>

	                            <tbody id="cartTableBody">
	                            <!-- dynamically added rows -->
	                            </tbody>
	                        </table>
	
	                        <div class="d-flex justify-content-between mt-3">
							    <div>
							        <strong>Quantity:</strong> <span id="totalQuantity">0</span><br>
							        <strong>Total Amount:</strong> <span id="totalAmount">0.00</span>
							    </div>
							    <div>
							        <strong>Total Discount:</strong> <span id="totalDiscount">0.00</span><br>
							        <strong>Grand Total:</strong> <span id="grandTotal">0.00</span><br>
							
							        <!-- ‚úÖ New lines -->
							        <strong>Amount Paid:</strong> <span id="displayAmountPaid">0.00</span><br>
							        <strong>Amount Due:</strong> <span id="displayAmountDue">0.00</span>
							    </div>
							</div>

	                        <input type="hidden" id="subTotalInput" name="subTotal">
							<input type="hidden" id="discountInput" name="discount">
							<input type="hidden" id="grandTotalInput" name="grandTotal">
							<input type="hidden" id="amountPaidInput" name="amountPaid">
							<input type="hidden" id="amountDueInput" name="amountDue">
							<input type="hidden" id="invoiceNumberInput" name="invoiceNumber">
							<input type="hidden" id="finAccNameInput" name="finAccName">
							<input type="hidden" id="paymentMethodInput" name="paymentMethod">

	                        <hr>
	
	                        <div class="d-flex justify-content-between mt-3">
							    <button type="button" class="btn btn-success btn-lg" style="border-radius: 0;" id="openPaymentModal">
							        Receive Payment
							    </button>
							
							    <!-- ‚úÖ New Submit Button on the right -->
							     <button type="submit" class="btn btn-primary btn-lg" style="border-radius: 0;" id="submitOrderBtn">
							        Submit Order
							    </button>
							</div>


	                    </form>
	                </div>
	            </div>
	        </div>
	
	        <!-- ‚úÖ Right: Product Grid -->
	        <div class="col-md-5">
	            <div class="d-flex mb-3">
	                <select class="form-select me-2" style="width: 50%;">
	                    <option>All Categories</option>
	                    <option th:each="cat : ${categories}" th:text="${cat.name}"></option>
	                </select>
	                <input type="text" class="form-control" placeholder="Filter items">
	            </div>
	
	            <div class="row g-3">
	                <div class="col-4" th:each="product : ${products}">
	                    <div class="product-card"
	                         th:data-id="${product.id}"
	                         th:data-name="${product.name}"
	                         th:data-sellingPrice="${product.sellingPrice}"
	                         th:data-quantity="${product.quantity}">
	                        <!-- ‚úÖ fallback image if product has no image field -->
	                        <h5>Product Name</h5>
	                        <h6 th:text="${product.name}"></h6>
	                        <p>Stock: <span th:text="${product.quantity}"></span></p>
	                        <p> <span th:text="${product.sellingPrice}"></span></p>
	                    </div>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>


<!-- üí≥ Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paymentModalLabel">Receive Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Subtotal</label>
          <input type="text" id="modalSubTotal" class="form-control" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">Discount</label>
          <div class="input-group">
            <input type="number" id="discountAmount" class="form-control" min="0" step="0.01" placeholder="0.00">
            <span class="input-group-text">BDT</span>
          </div>
          <small class="text-muted">Enter discount amount</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Grand Total</label>
          <input type="text" id="modalGrandTotal" class="form-control" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">Amount Paid</label>
          <div class="input-group">
            <input type="number" id="amountPaid" class="form-control" min="0" step="0.01" required>
            <span class="input-group-text">BDT</span>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Amount Due</label>
          <input type="text" id="amountDue" class="form-control" readonly value="0.00">
        </div>
        
      <div class="mb-3">
		  <label class="form-label">Payment Method</label>
		  <select id="paymentMethodSelect" class="form-select">
		      <option value="">-- Select Method --</option>
		      <option value="CASH">Cash</option>
		      <option value="MFS">MFS</option>
		      <option value="BANK">Bank Transfer</option>
		  </select>
		</div>
		
		<div class="mb-3">
		  <label class="form-label">Account</label>
		  <select id="finAccSelect" class="form-select">
		      <option value="">-- Select Account --</option>
		      <!-- Options will be loaded dynamically -->
		  </select>
		</div>
		
		<!-- Hidden inputs for backend submission -->
		<input type="hidden" name="paymentMethod" id="paymentMethodInput">
		<input type="hidden" name="finAccName" id="finAccNameInput">
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmPayment">Confirm Payment</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalLabel">Add Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm" th:action="@{/customer}" th:object="${customer}" method="post">
          <div class="mb-2">
            <label for="name">Name</label>
            <input type="text" class="form-control" id="name" th:field="*{name}" required>
          </div>
          <div class="mb-2">
            <label for="address">Address</label>
            <input type="text" class="form-control" id="address" th:field="*{address}" required>
          </div>
          <div class="mb-2">
            <label for="phoneNumber">Phone Number</label>
            <input type="text" class="form-control" id="phoneNumber" th:field="*{phoneNumber}" required>
          </div>
          <input type="hidden" th:field="*{id}">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="submitCustomerBtn">Submit</button>
      </div>
    </div>
  </div>
</div>


<script>
// Store original product order for resetting
let originalProductOrder = [];
let currentSubTotal = 0;
let currentDiscount = 0;
let currentGrandTotal = 0;

$(document).ready(function() {
    // Store the original order of products when the page loads
    $(".row.g-3").children("div").each(function() {
        originalProductOrder.push($(this));
    });

    // Set default values on page load
    const grandTotal = parseFloat($("#grandTotal").text()) || 0;
    $("#displayAmountPaid").text("0.00");
    $("#displayAmountDue").text(grandTotal.toFixed(2));

    $("#grandTotalInput").val(grandTotal.toFixed(2));
    $("#amountPaidInput").val("0.00");
    $("#amountDueInput").val(grandTotal.toFixed(2));
});

// ------------------------
// Step 1: Real-time product search + alphabetical sorting
// ------------------------
$("#searchProduct").on("input", function () {
    const searchText = $(this).val().toLowerCase().trim();
    const container = $(".row.g-3");
    
    if (!searchText) {
        container.empty();
        originalProductOrder.forEach(function(product) {
            container.append(product);
            product.show();
        });
        return;
    }
    
    let matchingProducts = [];
    let nonMatchingProducts = [];
    
    originalProductOrder.forEach(function(product) {
        const productCard = product.find(".product-card");
        const name = (productCard.data("name") || "").toLowerCase();
        const barcode = (productCard.data("barcode") || "").toLowerCase();
        
        if (name.includes(searchText) || barcode.includes(searchText)) {
            matchingProducts.push(product);
        } else {
            nonMatchingProducts.push(product);
        }
    });
    
    matchingProducts.sort(function (a, b) {
        const nameA = a.find(".product-card").data("name").toLowerCase();
        const nameB = b.find(".product-card").data("name").toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    container.empty();
    matchingProducts.forEach(function(product) { container.append(product); product.show(); });
    nonMatchingProducts.forEach(function(product) { container.append(product); product.hide(); });
});

// ------------------------
// Step 2: Add product to cart on click
// ------------------------
$(document).on("click", ".product-card", function () {
    const productId = $(this).data("id"); 
    const name = $(this).data("name");
    const sellingPrice = parseFloat($(this).data("sellingprice"));
    const stockQuantity = parseInt($(this).data("quantity"));

    const existingRow = $(`#cartTableBody tr[data-product-id="${productId}"]`);
    if (existingRow.length > 0) {
        const currentQty = parseInt(existingRow.find(".qty").val());
        if (currentQty >= stockQuantity) { alert(`Cannot add more! Only ${stockQuantity} items available.`); return; }
        existingRow.find(".qty").val(currentQty + 1).trigger("input");
        return;
    }

    if (stockQuantity <= 0) { alert("This product is out of stock!"); return; }

    const row = `<tr data-product-id="${productId}">
        <td>${name}</td>
        <td class="stock-quantity">${stockQuantity}</td>
        <td>
            <input type="number" class="form-control qty" value="1" min="1" max="${stockQuantity}" data-max="${stockQuantity}">
            <small class="text-danger stock-warning" style="display: none; font-size: 0.7rem;">Exceeds stock!</small>
        </td>
        <td class="sellingPrice">${sellingPrice.toFixed(2)}</td>
        <td class="subtotal">${sellingPrice.toFixed(2)}</td>
        <td><button type="button" class="btn btn-danger btn-sm remove">üóë</button></td>
    </tr>`;
    $("#cartTableBody").append(row);
    updateTotals();
    $("#searchProduct").val("").trigger("input");
});

// ------------------------
// Step 3: Quantity change & remove
// ------------------------
$(document).on("input", ".qty", function () {
    const qty = parseInt($(this).val()) || 0;
    const maxStock = parseInt($(this).data("max"));
    const stockWarning = $(this).siblings(".stock-warning");
    
    if (qty > maxStock) { $(this).val(maxStock); stockWarning.show(); setTimeout(() => stockWarning.hide(), 3000); return; }
    stockWarning.hide();

    const sellingPrice = parseFloat($(this).closest("tr").find(".sellingPrice").text());
    $(this).closest("tr").find(".subtotal").text((qty * sellingPrice).toFixed(2));
    updateTotals();
});

$(document).on("click", ".remove", function () {
    $(this).closest("tr").remove();
    updateTotals();
});

// ------------------------
// Step 4: Update totals
// ------------------------
function updateTotals() {
    let totalQty = 0;
    let totalAmount = 0;
    $("#cartTableBody tr").each(function () {
        totalQty += parseInt($(this).find(".qty").val());
        totalAmount += parseFloat($(this).find(".subtotal").text());
    });

    currentSubTotal = totalAmount;
    currentGrandTotal = currentSubTotal - currentDiscount;

    $("#totalQuantity").text(totalQty);
    $("#totalAmount").text(totalAmount.toFixed(2));
    $("#grandTotal").text(currentGrandTotal.toFixed(2));
}

// ------------------------
// Step 5: Payment Modal Open
// ------------------------
let paymentDone = false;
let alertShown = false;

$(document).on("click", "#openPaymentModal", function () {
    currentSubTotal = parseFloat($("#totalAmount").text()) || 0;
    currentDiscount = 0;
    currentGrandTotal = currentSubTotal;

    $("#modalSubTotal").val(currentSubTotal.toFixed(2));
    $("#discountAmount").val("0.00");
    $("#modalGrandTotal").val(currentGrandTotal.toFixed(2));
    $("#amountPaid").val("");
    $("#amountDue").val(currentGrandTotal.toFixed(2));

    // Reset Payment Method & Account dropdowns
    $("#paymentMethodSelect").val("");
    $("#finAccSelect").empty().append('<option value="">-- Select Account --</option>');

    const paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));
    paymentModal.show();
});

// ------------------------
// Step 6: Payment Method change -> load accounts dynamically
// ------------------------
$(document).on("change", "#paymentMethodSelect", function() {
    const type = $(this).val();
    const accountSelect = $("#finAccSelect");

    accountSelect.empty().append('<option value="">-- Select Account --</option>');
    if (!type) return;

    $.ajax({
        url: '/accounts/by-type',
        type: 'GET',
        data: { type: type },
        success: function(accounts) {
            accounts.forEach(acc => {
                accountSelect.append(`<option value="${acc.finAccName}">${acc.finAccName}</option>`);
            });
        },
        error: function() { alert("Failed to fetch accounts for " + type); }
    });
});

// ------------------------
// Step 7: Discount & Paid amount input
// ------------------------
$(document).on("input", "#discountAmount", function () {
    const discount = parseFloat($(this).val()) || 0;
    currentDiscount = Math.min(discount, currentSubTotal);
    currentGrandTotal = Math.max(currentSubTotal - currentDiscount, 0);
    $("#modalGrandTotal").val(currentGrandTotal.toFixed(2));

    const paid = parseFloat($("#amountPaid").val()) || 0;
    $("#amountDue").val(Math.max(currentGrandTotal - paid, 0).toFixed(2));
});

$(document).on("input", "#amountPaid", function () {
    const paid = parseFloat($(this).val()) || 0;
    $("#amountDue").val(Math.max(currentGrandTotal - paid, 0).toFixed(2));
});

// ------------------------
// Step 8: Confirm Payment
// ------------------------
$(document).on("click", "#confirmPayment", function () {
    const amountPaid = parseFloat($("#amountPaid").val()) || 0;
    const amountDue = Math.max(currentGrandTotal - amountPaid, 0);

    const paymentMethod = $("#paymentMethodSelect").val();
    const finAccName = $("#finAccSelect").val();
    if (!paymentMethod || !finAccName) { alert("Please select both Payment Method and Account!"); return; }

    // Fill hidden fields
    $("#paymentMethodInput").val(paymentMethod);
    $("#finAccNameInput").val(finAccName);
    $("#subTotalInput").val(currentSubTotal.toFixed(2));
    $("#discountInput").val(currentDiscount.toFixed(2));
    $("#grandTotalInput").val(currentGrandTotal.toFixed(2));
    $("#amountPaidInput").val(amountPaid.toFixed(2));
    $("#amountDueInput").val(amountDue.toFixed(2));

    // Update visible summary
    $("#displaySubTotal").text(currentSubTotal.toFixed(2));
    $("#displayDiscount").text(currentDiscount.toFixed(2));
    $("#displayGrandTotal").text(currentGrandTotal.toFixed(2));
    $("#displayAmountPaid").text(amountPaid.toFixed(2));
    $("#displayAmountDue").text(amountDue.toFixed(2));

    // Generate invoice number
    const now = new Date();
    const invoiceNumber = `INV-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${Math.floor(Math.random()*9000+1000)}`;
    $("#invoiceNumberInput").val(invoiceNumber);

    paymentDone = true;
    const paymentModalEl = document.getElementById("paymentModal");
    bootstrap.Modal.getInstance(paymentModalEl).hide();
});

// ------------------------
// Step 9: Submit Order
// ------------------------
$(document).on("click", "#submitOrderBtn", function (e) {
    if (!paymentDone) {
        e.preventDefault();
        if (!alertShown) { alert("Payment is not done yet. Click 'Receive Payment' to add payment."); alertShown = true; }
        return;
    }
    addOrderDetailsToForm();
    $(this).closest("form").submit();
});

// ------------------------
// Step 10: Add products as hidden fields
// ------------------------
function addOrderDetailsToForm() {
    $("input.dynamic-product").remove();

    $("#cartTableBody tr").each(function () {
        const productId = $(this).data("product-id");
        const quantity = $(this).find(".qty").val();
        const sellingPrice = $(this).find(".sellingPrice").text();

        $("<input>").attr({ type: "hidden", name: "product_" + productId, value: productId, class: "dynamic-product" }).appendTo("#posForm");
        $("<input>").attr({ type: "hidden", name: "quantity_" + productId, value: quantity, class: "dynamic-product" }).appendTo("#posForm");
        $("<input>").attr({ type: "hidden", name: "sellingPrice_" + productId, value: sellingPrice, class: "dynamic-product" }).appendTo("#posForm");
    });
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/pos_customer.js"></script>
</body>
</html>
