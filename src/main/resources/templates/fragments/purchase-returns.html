<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Purchase Returns</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .summary-card { transition: transform 0.2s; }
        .summary-card:hover { transform: translateY(-3px); }
        .bg-light-green { background-color: #d2f8d2; }
        .bg-light-blue { background-color: #e3f2fd; }
        .bg-light-yellow { background-color: #fff9db; }
    </style>
</head>
<body>
<div layout:fragment="content" class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 fw-bold"><i class="bi bi-arrow-counterclockwise"></i> Purchase Returns</h1>
        <a th:href="@{/purchase-return/new}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> New Return
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card summary-card border-success bg-light-green">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-success">Total Returns</h6>
                            <h3 class="text-success fw-bold" th:text="${totalReturns}">0</h3>
                        </div>
                        <i class="bi bi-box-seam text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card summary-card border-primary bg-light-blue">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-primary">Total Return Value</h6>
                            <h3 class="text-primary fw-bold" 
                                th:text="${#numbers.formatDecimal(totalReturnValue, 1, 2, 'POINT')}">0.00</h3>
                        </div>
                        <i class="bi bi-cash-coin text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card summary-card border-warning bg-light-yellow">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-warning">Total Suppliers</h6>
                            <h3 class="text-warning fw-bold" th:text="${supplierCount}">0</h3>
                        </div>
                        <i class="bi bi-people text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <form id="filterForm" class="row g-3 align-items-end mb-3">
        <div class="col-md-4">
            <label class="form-label">Supplier</label>
            <select class="form-select" name="supplierId" id="supplierId">
                <option value="">All Suppliers</option>
                <option th:each="s : ${suppliers}" th:value="${s.id}" th:text="${s.supplierName}"></option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" name="startDate" id="startDate">
        </div>

        <div class="col-md-3">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" name="endDate" id="endDate">
        </div>

        <div class="col-md-2 d-grid">
            <button type="button" class="btn btn-success btn-filters">
                <i class="bi bi-funnel"></i> Filter
            </button>
        </div>
    </form>

    <!-- Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ref No</th>
                        <th>Supplier</th>
                        <th>Date</th>
                        <th>Total Amount</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
				    <tr th:each="pr : ${purchaseReturns}">
				        <td th:text="${pr.returnRefNo}">PR-001</td>
				        <td th:text="${pr.supplier.supplierName}">ABC Traders</td>
				        <td th:text="${#temporals.format(pr.returnDate, 'dd-MM-yyyy HH:mm')}">12-10-2025</td>
				        <td th:text="${#numbers.formatDecimal(pr.totalReturnAmount, 1, 'POINT', 2, 'NONE')}">1000.00</td>
				        <td th:text="${pr.remarks}">Defective Items</td>
				        <td>
				            <button class="btn btn-sm btn-info view-return" th:data-id="${pr.id}">
				                <i class="bi bi-eye"></i> View
				            </button>
				            <button class="btn btn-sm btn-danger delete-return" th:data-id="${pr.id}">
				                <i class="bi bi-trash"></i> Delete
				            </button>
				        </td>
				    </tr>
				
				    <!-- Empty row -->
				    <tr th:if="${#lists.isEmpty(purchaseReturns)}">
				        <td colspan="6" class="text-center text-muted py-4">
				            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
				            <p class="mt-2">No purchase returns found</p>
				            <a href="/purchase-return/new" class="btn btn-primary btn-sm">Add New Return</a>
				        </td>
				    </tr>
				</tbody>

            </table>
        </div>
    </div>
</div>

<!-- Modal (View Details) -->
<div class="modal fade" id="viewReturnModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Purchase Return Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="returnDetailsBody">
        <p>Loading...</p>
      </div>
    </div>
  </div>
</div>

<!-- JS Section -->
<script th:inline="javascript">
    $(document).ready(function () {

        // ✅ Filter Button Click
        $(".btn-filters").click(function () {
            const supplierId = $("#supplierId").val();
            const startDate = $("#startDate").val();
            const endDate = $("#endDate").val();

            const query = `?supplierId=${supplierId}&startDate=${startDate}&endDate=${endDate}`;
            window.location.href = '/purchase-return/filter' + query;
        });

        // ✅ View Return Details
        $(".view-return").click(function () {
            const id = $(this).data("id");
            $.ajax({
                url: '/purchase-return/details/' + id,
                method: 'GET',
                success: function (data) {
                    $("#returnDetailsBody").html(data);
                    $("#viewReturnModal").modal("show");
                },
                error: function () {
                    Swal.fire("Error", "Failed to load return details", "error");
                }
            });
        });

        // ✅ Delete Return
        $(".delete-return").click(function () {
            const id = $(this).data("id");
            Swal.fire({
                title: "Are you sure?",
                text: "This action cannot be undone!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it!",
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/purchase-return/delete/' + id,
                        method: 'POST',
                        success: function () {
                            Swal.fire("Deleted!", "Return deleted successfully", "success")
                                .then(() => location.reload());
                        },
                        error: function () {
                            Swal.fire("Error", "Unable to delete return", "error");
                        }
                    });
                }
            });
        });

    });
</script>

</body>
</html>
