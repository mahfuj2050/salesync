<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Products Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .summary-card {
      transition: transform 0.2s;
    }
    .summary-card:hover {
      transform: translateY(-2px);
    }
    .bg-light-blue {
      background-color: #e3f2fd;
    }
    .bg-light-orange {
      background-color: #fff3e0;
    }
    .bg-light-green {
      background-color: #e8f5e8;
    }
    .low-stock {
      background-color: #fff3cd !important;
    }
    .out-of-stock {
      background-color: #f8d7da !important;
    }
    .stock-status {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 10px;
    }
    .pagination .page-link {
      color: #495057;
    }
    .pagination .page-item.active .page-link {
      background-color: #007bff;
      border-color: #007bff;
    }
  </style>
</head>

<body>
  <div layout:fragment="content" class="container-fluid py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Products Management</h1>
      <a sec:authorize="hasRole('ROLE_ADMIN')" th:href="@{/product}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add New Product
      </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card summary-card border-primary bg-light-blue">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-primary">Total Products</h6>
                <h3 class="text-primary" th:text="${totalProducts}">0</h3>
              </div>
              <i class="bi bi-box-seam text-primary" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card summary-card border-warning bg-light-orange">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-warning">Low Stock</h6>
                <h3 class="text-warning" th:text="${lowStockCount}">0</h3>
              </div>
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card summary-card border-success bg-light-green">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="card-title text-success">In Stock Value</h6>
               <h3 class="text-success" th:text="${#numbers.formatDecimal(totalStockValue, 1, 2, 'POINT')}">$0.00</h3>
              </div>
              <i class="bi bi-currency-dollar text-success" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form th:action="@{/products}" method="get" class="row g-3" id="filterForm">
          <input type="hidden" name="page" th:value="${currentPage}">
          <input type="hidden" name="size" th:value="${currentSize}">
          <input type="hidden" name="sort" th:value="${currentSort}">
          <input type="hidden" name="direction" th:value="${currentDirection}">
          
          <div class="col-md-3">
            <input type="text" class="form-control" name="search" 
                   th:value="${currentSearch}" 
                   placeholder="Search by name, SKU, barcode...">
          </div>
          <div class="col-md-2">
            <select class="form-select" name="category">
              <option value="">All Categories</option>
              <option th:each="category : ${categories}" 
                      th:value="${category.id}" 
                      th:text="${category.name}"
                      th:selected="${currentCategory == category.id}">
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="brand">
              <option value="">All Brands</option>
              <option th:each="brand : ${brands}" 
                      th:value="${brand.id}" 
                      th:text="${brand.name}"
                      th:selected="${currentBrand == brand.id}">
              </option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" name="stockStatus">
              <option value="">All Stock</option>
              <option value="low" th:selected="${currentStockStatus == 'low'}">Low Stock</option>
              <option value="out" th:selected="${currentStockStatus == 'out'}">Out of Stock</option>
              <option value="in" th:selected="${currentStockStatus == 'in'}">In Stock</option>
            </select>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-outline-primary">
              <i class="bi bi-funnel"></i> Filter
            </button>
            <a th:href="@{/products}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-clockwise"></i> Clear
            </a>
            <button type="button" id="exportBtn" class="btn btn-outline-success">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Alerts -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
      <span th:text="${successMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
      <span th:text="${errorMessage}"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    

    <!-- Products Table -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-striped" id="productsTable">
            <thead class="table-dark">
              <tr>
                <th>
                  <a th:href="@{/products(size=${currentSize}, page=0, sort='name', direction=${currentDirection == 'asc' ? 'desc' : 'asc'}, search=${currentSearch}, category=${currentCategory}, brand=${currentBrand}, stockStatus=${currentStockStatus})}">
                    Name 
                    <i th:if="${currentSort == 'name'}" 
                       th:class="'bi bi-arrow-' + (${currentDirection == 'asc'} ? 'up' : 'down')"></i>
                    <i th:if="${currentSort != 'name'}" class="bi bi-arrow-down-up"></i>
                  </a>
                </th>
                <th>SKU</th>
                <th>Category</th>
                <th>Brand</th>
                <th>
				    <a th:href="@{/products(size=${currentSize}, page=0, sort='sellingPrice', direction=${currentDirection == 'asc' ? 'desc' : 'asc'}, search=${currentSearch}, category=${currentCategory}, brand=${currentBrand}, stockStatus=${currentStockStatus})}">
				        Price
				        <i th:if="${currentSort == 'sellingPrice'}" 
				           th:class="'bi bi-arrow-' + (${currentDirection == 'asc'} ? 'up' : 'down')"></i>
				        <i th:if="${currentSort != 'sellingPrice'}" class="bi bi-arrow-down-up"></i>
				    </a>
				</th>
                <th>
                  <a th:href="@{/products(size=${currentSize}, page=0, sort='quantity', direction=${currentDirection == 'asc' ? 'desc' : 'asc'}, search=${currentSearch}, category=${currentCategory}, brand=${currentBrand}, stockStatus=${currentStockStatus})}">
                    Stock
                    <i th:if="${currentSort == 'quantity'}" 
                       th:class="'bi bi-arrow-' + (${currentDirection == 'asc'} ? 'up' : 'down')"></i>
                    <i th:if="${currentSort != 'quantity'}" class="bi bi-arrow-down-up"></i>
                  </a>
                </th>
                </th>
                <th>Warranty</th>
                <th>Guarantee</th>
                <th>Status</th>
                <th>Unit</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="product : ${product_page.content}" 
                  th:classappend="${product.quantity == 0} ? 'out-of-stock' : (${product.quantity <= product.minStockLevel} ? 'low-stock' : '')">
                <td class="text-start" th:text="${product.name}"></td>
                <td th:text="${product.sku}" style="text-align: center;"></td>
                <td th:text="${product.category?.name ?: 'N/A'}"></td>
                <td th:text="${product.brand?.name ?: 'N/A'}"></td>
                <td th:text="${#numbers.formatDecimal(product.sellingPrice, 0, 2, 'POINT')}"></td>
                <td th:text="${product.quantity}"></td>
				<td>
				  <span th:if="${product.warrantyExpiryDate != null}">
				    <span th:text="${#temporals.format(product.warrantyExpiryDate, 'dd-MM-yyyy')}"></span><br>
				    <span th:text="${product.warrantyExpired ? 'Expired' : 'Active'}"
				          th:classappend="${product.warrantyExpired ? 'badge bg-danger stock-status' : 'badge bg-success stock-status'}">
				    </span>
				  </span>
				
				  <span th:if="${product.warrantyExpiryDate == null}"
				        class="badge bg-secondary stock-status">No Warranty</span>
				</td>
				
				<td>
				  <span th:if="${product.guaranteeExpiryDate != null}">
				    <span th:text="${#temporals.format(product.guaranteeExpiryDate, 'dd-MM-yyyy')}"></span><br>
				    <span th:text="${product.guaranteeExpired ? 'Expired' : 'Active'}"
				          th:classappend="${product.guaranteeExpired ? 'badge bg-danger stock-status' : 'badge bg-success stock-status'}">
				    </span>
				  </span>
				
				  <span th:if="${product.guaranteeExpiryDate == null}"
				        class="badge bg-secondary stock-status">No Guarantee</span>
				</td>


				<td>
				  <span th:if="${product.quantity == 0}" class="badge bg-danger stock-status">Out of Stock</span>
				  <span th:if="${product.quantity > 0 and product.quantity <= product.minStockLevel}"
				        class="badge bg-warning stock-status">Low Stock</span>
				  <span th:if="${product.quantity > product.minStockLevel}"
				        class="badge bg-success stock-status">In Stock</span>
				</td>


                <td th:text="${product.unitOfMeasure}"></td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a th:href="@{/product/{id}(id=${product.id})}" class="btn btn-outline-primary" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </a>
	               <button type="button"
					        class="btn btn-outline-danger"
					        th:onclick="|deleteEntity('product', ${product.id})|"
					        title="Delete">
					    <i class="bi bi-trash"></i>
					</button>

                  </div>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(product_page.content)}">
                <td colspan="9" class="text-center text-muted py-4">
                  <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                  <p class="mt-2">No products found</p>
                  <a th:href="@{/products}" class="btn btn-primary btn-sm">Clear Filters</a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

<!-- Pagination -->
<nav th:if="${product_page.totalPages > 1}">
  <div class="d-flex justify-content-between align-items-center">
    <div class="text-muted small">
      Showing <span th:text="${product_page.number * product_page.size + 1}">1</span> to 
      <span th:text="${(product_page.number * product_page.size) + product_page.numberOfElements}">0</span> of 
      <span th:text="${product_page.totalElements}">0</span> products
    </div>
    <ul class="pagination justify-content-center mb-0">
      <!-- Previous Page -->
      <li class="page-item" th:classappend="${product_page.first} ? 'disabled'">
        <a class="page-link" 
           th:href="@{/products(size=${currentSize}, page=${product_page.number - 1}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, category=${currentCategory != null ? currentCategory : ''}, brand=${currentBrand != null ? currentBrand : ''}, stockStatus=${currentStockStatus})}">
          Previous
        </a>
      </li>
      
      <!-- Page Numbers -->
      <li th:each="i: ${#numbers.sequence(0, product_page.totalPages-1)}" 
          class="page-item" 
          th:classappend="${i == product_page.number} ? 'active'">
        <a class="page-link" 
           th:href="@{/products(size=${currentSize}, page=${i}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, category=${currentCategory != null ? currentCategory : ''}, brand=${currentBrand != null ? currentBrand : ''}, stockStatus=${currentStockStatus})}"
           th:text="${i + 1}">1</a>
      </li>
      
      <!-- Next Page -->
      <li class="page-item" th:classappend="${product_page.last} ? 'disabled'">
        <a class="page-link" 
           th:href="@{/products(size=${currentSize}, page=${product_page.number + 1}, sort=${currentSort}, direction=${currentDirection}, search=${currentSearch}, category=${currentCategory != null ? currentCategory : ''}, brand=${currentBrand != null ? currentBrand : ''}, stockStatus=${currentStockStatus})}">
          Next
        </a>
      </li>
    </ul>
  </div>
</nav>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <form th:action="@{/products/delete}" method="post" id="deleteForm">
          <input type="hidden" name="id" id="deleteProductId">
          <div class="modal-content">
            <div class="modal-header bg-danger text-white">
              <h5 class="modal-title">Confirm Delete</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this product? This action cannot be undone.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-danger">Delete</button>
            </div>
          </div>
        </form>
      </div>
    </div>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    console.log("ðŸš€ DOM Loaded - Products Page");

    function submitFilters() {
      const form = document.getElementById('filterForm');
      const formData = new FormData(form);
      const params = new URLSearchParams();
      
      console.log("ðŸ“ Form data before submission:");
      // Add all form data to URL params
      for (let [key, value] of formData.entries()) {
        console.log("  ", key, ":", value);
        if (value) {
          params.append(key, value);
        }
      }
      
      // Always include page=0 when filters change
      params.set('page', '0');
      
      console.log("ðŸ”— Building URL with params:", params.toString());
      window.location.href = '/products?' + params.toString();
    }

    // Auto-submit filters on change
    const filters = document.querySelectorAll('select[name="category"], select[name="brand"], select[name="stockStatus"]');
    console.log("ðŸ” Found filters:", filters.length);
    
    filters.forEach(filter => {
      filter.addEventListener('change', function() {
        console.log("ðŸ”„ Filter changed:", this.name, "=", this.value);
        
        // Update the hidden page field
        document.querySelector('input[name="page"]').value = '0';
        console.log("ðŸ“„ Set page to 0");
        
        submitFilters();
      });
    });

    // Real-time search with debounce
    const searchInput = document.querySelector('input[name="search"]');
    let searchTimeout;
    
    if (searchInput) {
      console.log("ðŸ” Search input found, current value:", searchInput.value);
      
      searchInput.addEventListener('input', function() {
        const searchValue = this.value;
        console.log("âŒ¨ï¸ Search input changed to:", searchValue);
        
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          console.log("â° Search timeout triggered, submitting...");
          
          // Update the hidden page field
          document.querySelector('input[name="page"]').value = '0';
          
          submitFilters();
        }, 1000);
      });
    }

    // Debug: Check hidden field values
    console.log("ðŸ” Hidden field values:");
    const hiddenFields = document.querySelectorAll('#filterForm input[type="hidden"]');
    hiddenFields.forEach(field => {
      console.log("  ", field.name, ":", field.value);
    });

    // Debug: Check current select values
    console.log("ðŸ” Current select values:");
    const selects = document.querySelectorAll('#filterForm select');
    selects.forEach(select => {
      console.log("  ", select.name, ":", select.value);
    });
  });
</script>
  </div>
</body>
</html>